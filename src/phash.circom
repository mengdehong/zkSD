pragma circom 2.1.5;
include "../circomlib/comparators.circom";
include "../circomlib/switcher.circom";

// 计算两个二进制哈希之间的汉明距离
template HammingDistance(HASH_SIZE) {
    signal input hashA[HASH_SIZE][HASH_SIZE];
    signal input hashB[HASH_SIZE][HASH_SIZE];
    signal output distance;
    
    signal diff[HASH_SIZE][HASH_SIZE];
    for (var i = 0; i < HASH_SIZE; i++) {
        for (var j = 0; j < HASH_SIZE; j++) {
            diff[i][j] <== hashA[i][j] + hashB[i][j] - 2 * hashA[i][j] * hashB[i][j];
        }
    }
    
    signal sums[HASH_SIZE * HASH_SIZE];
    var idx = 0;
    for (var i = 0; i < HASH_SIZE; i++) {
        for (var j = 0; j < HASH_SIZE; j++) {
            if (idx == 0) {
                sums[idx] <== diff[i][j];
            } else {
                sums[idx] <== sums[idx-1] + diff[i][j];
            }
            idx++;
        }
    }
    
    distance <== sums[HASH_SIZE * HASH_SIZE - 1];
}

// 计算一行或一列的 1D DCT（离散余弦变换）
template DCT1D(N, SCALE) {
    signal input in[N];          // 输入：长度为 N 的信号数组
    signal output out[N];        // 输出：变换后的 DCT 结果
    // 预计算好的 DCT 系数矩阵
    var coeff[32][32] = [
        [
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776,
        3260954456333195776
        ],
        [
        4606131040650198016,
        4561771480761380352,
        4473479567794875904,
        4342105601137822208,
        4168914783905441280,
        3955575038343412736,
        3704140942824866304,
        3417033945137503744,
        3097019042617703936,
        2747178153714674688,
        2370880437431032320,
        1971749846479847936,
        1553630226638953728,
        1120548298414853888,
        676674877523008768,
        226284707652502656,
        -226284707652502112,
        -676674877523008256,
        -1120548298414853376,
        -1553630226638953216,
        -1971749846479846400,
        -2370880437431032320,
        -2747178153714674176,
        -3097019042617704448,
        -3417033945137502720,
        -3704140942824865792,
        -3955575038343412224,
        -4168914783905441280,
        -4342105601137821696,
        -4473479567794875904,
        -4561771480761380352,
        -4606131040650198016
        ],
        [
        4589479489746652160,
        4413108366765437952,
        4067143964149113344,
        3564881499871150592,
        2925622638761716736,
        2173933740352749056,
        1338701787458110720,
        452024275624070656,
        -452024275624070080,
        -1338701787458109952,
        -2173933740352748544,
        -2925622638761716224,
        -3564881499871150592,
        -4067143964149112832,
        -4413108366765437952,
        -4589479489746651648,
        -4589479489746652160,
        -4413108366765438464,
        -4067143964149113344,
        -3564881499871151104,
        -2925622638761718784,
        -2173933740352749312,
        -1338701787458111232,
        -452024275624069184,
        452024275624067520,
        1338701787458109440,
        2173933740352748032,
        2925622638761717248,
        3564881499871149056,
        4067143964149112320,
        4413108366765437952,
        4589479489746652160
        ],
        [
        4561771480761380352,
        4168914783905441280,
        3417033945137503744,
        2370880437431032320,
        1120548298414853888,
        -226284707652501088,
        -1553630226638954240,
        -2747178153714672128,
        -3704140942824866816,
        -4342105601137821696,
        -4606131040650198016,
        -4473479567794875904,
        -3955575038343412736,
        -3097019042617705472,
        -1971749846479849216,
        -676674877523011328,
        676674877523009664,
        1971749846479847680,
        3097019042617703936,
        3955575038343412224,
        4473479567794874880,
        4606131040650198016,
        4342105601137821696,
        3704140942824865280,
        2747178153714677248,
        1553630226638957568,
        226284707652502784,
        -1120548298414856320,
        -2370880437431031296,
        -3417033945137504768,
        -4168914783905440256,
        -4561771480761380352
        ],
        [
        4523073764714962944,
        3834476785802888704,
        2562115475870945792,
        899695310372275840,
        -899695310372275200,
        -2562115475870944256,
        -3834476785802889216,
        -4523073764714962944,
        -4523073764714962944,
        -3834476785802889728,
        -2562115475870945280,
        -899695310372277376,
        899695310372275712,
        2562115475870943744,
        3834476785802888704,
        4523073764714962432,
        4523073764714962944,
        3834476785802889728,
        2562115475870945792,
        899695310372277888,
        -899695310372271104,
        -2562115475870943232,
        -3834476785802888192,
        -4523073764714963456,
        -4523073764714963968,
        -3834476785802890240,
        -2562115475870946304,
        -899695310372274432,
        899695310372270592,
        2562115475870942720,
        3834476785802888192,
        4523073764714962944
        ],
        [
        4473479567794875904,
        3417033945137503744,
        1553630226638953728,
        -676674877523008256,
        -2747178153714674176,
        -4168914783905440256,
        -4606131040650198016,
        -3955575038343412736,
        -2370880437431032832,
        -226284707652502208,
        1971749846479847680,
        3704140942824864256,
        4561771480761380352,
        4342105601137822720,
        3097019042617702912,
        1120548298414855040,
        -1120548298414856320,
        -3097019042617700864,
        -4342105601137820672,
        -4561771480761380864,
        -3704140942824868352,
        -1971749846479850240,
        226284707652499392,
        2370880437431037440,
        3955575038343411712,
        4606131040650198016,
        4168914783905441792,
        2747178153714674688,
        676674877523017088,
        -1553630226638946304,
        -3417033945137504256,
        -4473479567794876416
        ],
        [
        4413108366765437952,
        2925622638761716736,
        452024275624070656,
        -2173933740352748544,
        -4067143964149112832,
        -4589479489746652160,
        -3564881499871150080,
        -1338701787458115072,
        1338701787458113536,
        3564881499871149056,
        4589479489746652160,
        4067143964149113344,
        2173933740352749824,
        -452024275624066944,
        -2925622638761713664,
        -4413108366765436416,
        -4413108366765437440,
        -2925622638761716224,
        -452024275624070272,
        2173933740352747008,
        4067143964149108224,
        4589479489746652160,
        3564881499871148544,
        1338701787458108928,
        -1338701787458104064,
        -3564881499871144960,
        -4589479489746651648,
        -4067143964149110272,
        -2173933740352751360,
        452024275624073408,
        2925622638761712128,
        4413108366765438464
        ],
        [
        4342105601137822208,
        2370880437431032320,
        -676674877523008256,
        -3417033945137502720,
        -4606131040650198016,
        -3704140942824867840,
        -1120548298414850560,
        1971749846479844096,
        4168914783905441792,
        4473479567794877440,
        2747178153714673664,
        -226284707652499968,
        -3097019042617706496,
        -4561771480761378816,
        -3955575038343413760,
        -1553630226638958080,
        1553630226638954496,
        3955575038343411712,
        4561771480761379840,
        3097019042617709568,
        226284707652512096,
        -2747178153714670592,
        -4473479567794876416,
        -4168914783905441792,
        -1971749846479858688,
        1120548298414846720,
        3704140942824865280,
        4606131040650198016,
        3417033945137508352,
        676674877523010048,
        -2370880437431036416,
        -4342105601137825280
        ],
        [
        4260642322793532416,
        1764815834521887744,
        -1764815834521887232,
        -4260642322793532416,
        -4260642322793532928,
        -1764815834521890048,
        1764815834521888512,
        4260642322793531392,
        4260642322793532416,
        1764815834521890560,
        -1764815834521888000,
        -4260642322793530880,
        -4260642322793532416,
        -1764815834521891072,
        1764815834521887488,
        4260642322793530880,
        4260642322793532416,
        1764815834521891584,
        -1764815834521886976,
        -4260642322793530880,
        -4260642322793536000,
        -1764815834521892096,
        1764815834521886464,
        4260642322793533440,
        4260642322793536000,
        1764815834521892608,
        -1764815834521885952,
        -4260642322793533440,
        -4260642322793536512,
        -1764815834521893120,
        1764815834521885440,
        4260642322793532928
        ],
        [
        4168914783905441280,
        1120548298414853888,
        -2747178153714674176,
        -4606131040650198016,
        -3097019042617705472,
        676674877523005696,
        3955575038343412224,
        4342105601137822720,
        1553630226638953728,
        -2370880437431031296,
        -4561771480761380352,
        -3417033945137507328,
        226284707652499392,
        3704140942824865792,
        4473479567794875392,
        1971749846479850752,
        -1971749846479846144,
        -4473479567794874368,
        -3704140942824868864,
        -226284707652504480,
        3417033945137492480,
        4561771480761379840,
        2370880437431028224,
        -1553630226638960640,
        -4342105601137819648,
        -3955575038343414784,
        -676674877523010688,
        3097019042617704448,
        4606131040650198528,
        2747178153714682880,
        -1120548298414845056,
        -4168914783905438720
        ],
        [
        4067143964149113344,
        452024275624070656,
        -3564881499871150592,
        -4413108366765438464,
        -1338701787458111232,
        2925622638761714176,
        4589479489746651648,
        2173933740352749824,
        -2173933740352747520,
        -4589479489746652160,
        -2925622638761716224,
        1338701787458104576,
        4413108366765438976,
        3564881499871153664,
        -452024275624073984,
        -4067143964149111808,
        -4067143964149110272,
        -452024275624079552,
        3564881499871144960,
        4413108366765440512,
        1338701787458117888,
        -2925622638761711616,
        -4589479489746652672,
        -2173933740352738048,
        2173933740352744960,
        4589479489746651648,
        2925622638761718272,
        -1338701787458109696,
        -4413108366765433344,
        -3564881499871160320,
        452024275624071168,
        4067143964149114368
        ],
        [
        3955575038343412736,
        -226284707652502112,
        -4168914783905441280,
        -3704140942824866304,
        676674877523009664,
        4342105601137820672,
        3417033945137501184,
        -1120548298414848384,
        -4473479567794876416,
        -3097019042617709056,
        1553630226638954496,
        4561771480761378816,
        2747178153714674688,
        -1971749846479838976,
        -4606131040650198016,
        -2370880437431042048,
        2370880437431036928,
        4606131040650198528,
        1971749846479844352,
        -2747178153714662912,
        -4561771480761382400,
        -1553630226638968064,
        3097019042617704448,
        4473479567794875904,
        1120548298414870272,
        -3417033945137502720,
        -4342105601137822720,
        -676674877523011840,
        3704140942824854016,
        4168914783905443328,
        226284707652490912,
        -3955575038343417856
        ],
        [
        3834476785802888704,
        -899695310372275200,
        -4523073764714962944,
        -2562115475870945280,
        2562115475870943744,
        4523073764714963968,
        899695310372273920,
        -3834476785802884096,
        -3834476785802885632,
        899695310372270592,
        4523073764714962944,
        2562115475870946816,
        -2562115475870942208,
        -4523073764714963968,
        -899695310372283520,
        3834476785802883072,
        3834476785802886656,
        -899695310372276992,
        -4523073764714962944,
        -2562115475870947840,
        2562115475870927360,
        4523073764714964480,
        899695310372269184,
        -3834476785802891264,
        -3834476785802896896,
        899695310372259200,
        4523073764714962432,
        2562115475870936064,
        -2562115475870939648,
        -4523073764714961408,
        -899695310372286848,
        3834476785802890240
        ],
        [
        3704140942824866304,
        -1553630226638953216,
        -4606131040650198016,
        -1120548298414854528,
        3955575038343412224,
        3417033945137506816,
        -1971749846479847168,
        -4561771480761380864,
        -676674877523008384,
        4168914783905439744,
        3097019042617703424,
        -2370880437431030272,
        -4473479567794875392,
        -226284707652504480,
        4342105601137820160,
        2747178153714681856,
        -2747178153714676224,
        -4342105601137822720,
        226284707652497120,
        4473479567794873856,
        2370880437431043584,
        -3097019042617704448,
        -4168914783905442816,
        676674877523017344,
        4561771480761378304,
        1971749846479861248,
        -3417033945137512960,
        -3955575038343407616,
        1120548298414827520,
        4606131040650198016,
        1553630226638955264,
        -3704140942824862720
        ],
        [
        3564881499871150592,
        -2173933740352748544,
        -4413108366765438464,
        452024275624067520,
        4589479489746652160,
        1338701787458115584,
        -4067143964149115904,
        -2925622638761722368,
        2925622638761719296,
        4067143964149117952,
        -1338701787458111744,
        -4589479489746652160,
        -452024275624063296,
        4413108366765433856,
        2173933740352751872,
        -3564881499871144448,
        -3564881499871149568,
        2173933740352744960,
        4413108366765435904,
        -452024275624055424,
        -4589479489746650112,
        -1338701787458119424,
        4067143964149114368,
        2925622638761719296,
        -2925622638761697280,
        -4067143964149120000,
        1338701787458108160,
        4589479489746651136,
        452024275624083520,
        -4413108366765437440,
        -2173933740352740864,
        3564881499871162880
        ],
        [
        3417033945137503744,
        -2747178153714674176,
        -3955575038343412736,
        1971749846479847680,
        4342105601137822720,
        -1120548298414848384,
        -4561771480761379328,
        226284707652499392,
        4606131040650198016,
        676674877523017088,
        -4473479567794876416,
        -1553630226638967040,
        4168914783905439232,
        2370880437431042560,
        -3704140942824864768,
        -3097019042617711104,
        3097019042617704448,
        3704140942824869888,
        -2370880437431035392,
        -4168914783905442816,
        1553630226638943488,
        4473479567794880512,
        -676674877523016832,
        -4606131040650198016,
        -226284707652507840,
        4561771480761378304,
        1120548298414872448,
        -4342105601137824256,
        -1971749846479877632,
        3955575038343408640,
        2747178153714685952,
        -3417033945137511424
        ],
        [
        3260954456333195776,
        -3260954456333195264,
        -3260954456333196288,
        3260954456333194752,
        3260954456333196288,
        -3260954456333191680,
        -3260954456333193728,
        3260954456333191168,
        3260954456333194240,
        -3260954456333190656,
        -3260954456333194752,
        3260954456333190144,
        3260954456333195264,
        -3260954456333190144,
        -3260954456333195776,
        3260954456333189632,
        3260954456333195776,
        -3260954456333189120,
        -3260954456333196288,
        3260954456333188608,
        3260954456333208576,
        -3260954456333188608,
        -3260954456333197312,
        3260954456333199360,
        3260954456333209088,
        -3260954456333187584,
        -3260954456333197824,
        3260954456333198848,
        3260954456333210112,
        -3260954456333186560,
        -3260954456333198848,
        3260954456333197824
        ],
        [
        3097019042617703936,
        -3704140942824865792,
        -2370880437431032832,
        4168914783905440256,
        1553630226638953728,
        -4473479567794874368,
        -676674877523008384,
        4606131040650197504,
        -226284707652507008,
        -4561771480761380864,
        1120548298414862592,
        4342105601137822208,
        -1971749846479852544,
        -3955575038343414784,
        2747178153714675712,
        3417033945137508864,
        -3417033945137502720,
        -2747178153714683392,
        3955575038343409664,
        1971749846479861248,
        -4342105601137813504,
        -1120548298414855936,
        4561771480761378304,
        226284707652492064,
        -4606131040650199552,
        676674877522998912,
        4473479567794872832,
        -1553630226638956288,
        -4168914783905444352,
        2370880437431017984,
        3704140942824862720,
        -3097019042617700864
        ],
        [
        2925622638761716736,
        -4067143964149112832,
        -1338701787458111232,
        4589479489746652160,
        -452024275624066944,
        -4413108366765440000,
        2173933740352747008,
        3564881499871153664,
        -3564881499871150592,
        -2173933740352751360,
        4413108366765438464,
        452024275624080128,
        -4589479489746652672,
        1338701787458110208,
        4067143964149111296,
        -2925622638761711104,
        -2925622638761718784,
        4067143964149106688,
        1338701787458119936,
        -4589479489746651648,
        452024275624037440,
        4413108366765436928,
        -2173933740352756992,
        -3564881499871141376,
        3564881499871141888,
        2173933740352755968,
        -4413108366765436928,
        -452024275624068864,
        4589479489746654720,
        -1338701787458089728,
        -4067143964149121536,
        2925622638761707008
        ],
        [
        2747178153714674688,
        -4342105601137821696,
        -226284707652502208,
        4473479567794876416,
        -2370880437431031296,
        -3097019042617709056,
        4168914783905443328,
        676674877523017088,
        -4561771480761379840,
        1971749846479838464,
        3417033945137508352,
        -3955575038343410688,
        -1120548298414853760,
        4606131040650198528,
        -1553630226638959616,
        -3704140942824870400,
        3704140942824863744,
        1553630226638954240,
        -4606131040650197504,
        1120548298414827520,
        3955575038343416320,
        -3417033945137489920,
        -1971749846479847936,
        4561771480761382912,
        -676674877522982144,
        -4168914783905444352,
        3097019042617689088,
        2370880437431033344,
        -4473479567794872832,
        226284707652475136,
        4342105601137824768,
        -2747178153714683904
        ],
        [
        2562115475870945792,
        -4523073764714962944,
        899695310372275712,
        3834476785802889728,
        -3834476785802888192,
        -899695310372282496,
        4523073764714962432,
        -2562115475870942208,
        -2562115475870947328,
        4523073764714962944,
        -899695310372276992,
        -3834476785802895872,
        3834476785802891264,
        899695310372285184,
        -4523073764714961408,
        2562115475870940160,
        2562115475870936064,
        -4523073764714959360,
        899695310372258048,
        3834476785802897408,
        -3834476785802880512,
        -899695310372288000,
        4523073764714964992,
        -2562115475870965248,
        -2562115475870951936,
        4523073764714961920,
        -899695310372271360,
        -3834476785802890240,
        3834476785802870272,
        899695310372306816,
        -4523073764714962432,
        2562115475870948864
        ],
        [
        2370880437431032320,
        -4606131040650198016,
        1971749846479847680,
        2747178153714673664,
        -4561771480761380352,
        1553630226638946816,
        3097019042617703424,
        -4473479567794874368,
        1120548298414862592,
        3417033945137508352,
        -4342105601137825280,
        676674877523002240,
        3704140942824869888,
        -4168914783905438720,
        226284707652496000,
        3955575038343415808,
        -3955575038343417856,
        -226284707652507840,
        4168914783905436672,
        -3704140942824862720,
        -676674877523030272,
        4342105601137823744,
        -3417033945137511424,
        -1120548298414858240,
        4473479567794881024,
        -3097019042617700864,
        -1553630226638942464,
        4561771480761380864,
        -2747178153714657792,
        -1971749846479851008,
        4606131040650199040,
        -2370880437431057408
        ],
        [
        2173933740352749056,
        -4589479489746652160,
        2925622638761717248,
        1338701787458111744,
        -4413108366765437440,
        3564881499871145472,
        452024275624062720,
        -4067143964149118464,
        4067143964149115392,
        -452024275624056512,
        -3564881499871149568,
        4413108366765433344,
        -1338701787458109696,
        -2925622638761731584,
        4589479489746651648,
        -2173933740352729088,
        -2173933740352740096,
        4589479489746654208,
        -2925622638761721856,
        -1338701787458137344,
        4413108366765446656,
        -3564881499871131136,
        -452024275624068864,
        4067143964149113344,
        -4067143964149096960,
        452024275624066624,
        3564881499871153152,
        -4413108366765436416,
        1338701787458072320,
        2925622638761723904,
        -4589479489746654208,
        2173933740352766976
        ],
        [
        1971749846479847936,
        -4473479567794875904,
        3704140942824866816,
        -226284707652499968,
        -3417033945137507328,
        4561771480761378816,
        -2370880437431036928,
        -1553630226638967040,
        4342105601137822208,
        -3955575038343410688,
        676674877523002240,
        3097019042617711104,
        -4606131040650198016,
        2747178153714661888,
        1120548298414839552,
        -4168914783905443328,
        4168914783905444864,
        -1120548298414842880,
        -2747178153714672128,
        4606131040650199040,
        -3097019042617677312,
        -676674877523031296,
        3955575038343417344,
        -4342105601137823232,
        1553630226638939392,
        2370880437431034368,
        -4561771480761383424,
        3417033945137498624,
        226284707652562016,
        -3704140942824874496,
        4473479567794867712,
        -1971749846479859200
        ],
        [
        1764815834521887744,
        -4260642322793532928,
        4260642322793531392,
        -1764815834521888000,
        -1764815834521891072,
        4260642322793535488,
        -4260642322793533952,
        1764815834521871360,
        1764815834521877504,
        -4260642322793536512,
        4260642322793532928,
        -1764815834521884928,
        -1764815834521894144,
        4260642322793537024,
        -4260642322793526272,
        1764815834521868032,
        1764815834521880576,
        -4260642322793531392,
        4260642322793531904,
        -1764815834521881600,
        -1764815834521927680,
        4260642322793538560,
        -4260642322793537536,
        1764815834521895168,
        1764815834521914112,
        -4260642322793545216,
        4260642322793530368,
        -1764815834521908736,
        -1764815834521900544,
        4260642322793527296,
        -4260642322793523712,
        1764815834521892096
        ],
        [
        1553630226638953728,
        -3955575038343412736,
        4561771480761379840,
        -3097019042617700864,
        226284707652499392,
        2747178153714681344,
        -4473479567794875392,
        4168914783905439232,
        -1971749846479852544,
        -1120548298414869760,
        3704140942824860160,
        -4606131040650197504,
        3417033945137502208,
        -676674877522984448,
        -2370880437431045120,
        4342105601137823232,
        -4342105601137824256,
        2370880437431019008,
        676674877523014528,
        -3417033945137522688,
        4606131040650199040,
        -3704140942824861696,
        1120548298414855936,
        1971749846479835904,
        -4168914783905459200,
        4473479567794868224,
        -2747178153714682880,
        -226284707652480768,
        3097019042617729536,
        -4561771480761383424,
        3955575038343405568,
        -1553630226638950912
        ],
        [
        1338701787458110720,
        -3564881499871151104,
        4589479489746652160,
        -4067143964149112320,
        2173933740352747008,
        452024275624079040,
        -2925622638761717248,
        4413108366765440512,
        -4413108366765438464,
        2925622638761711616,
        -452024275624071680,
        -2173933740352753408,
        4067143964149111808,
        -4589479489746651648,
        3564881499871142400,
        -1338701787458091776,
        -1338701787458105856,
        3564881499871152128,
        -4589479489746653184,
        4067143964149105152,
        -2173933740352726016,
        -452024275624070016,
        2925622638761722880,
        -4413108366765433344,
        4413108366765431296,
        -2925622638761693184,
        452024275624097024,
        2173933740352730880,
        -4067143964149138432,
        4589479489746652160,
        -3564881499871148544,
        1338701787458100480
        ],
        [
        1120548298414853888,
        -3097019042617705472,
        4342105601137822720,
        -4561771480761380352,
        3704140942824865792,
        -1971749846479838976,
        -226284707652504480,
        2370880437431042560,
        -3955575038343414784,
        4606131040650198528,
        -4168914783905438720,
        2747178153714661888,
        -676674877523016832,
        -1553630226638970112,
        3417033945137510400,
        -4473479567794876928,
        4473479567794876928,
        -3417033945137489408,
        1553630226638940416,
        676674877523015680,
        -2747178153714700288,
        4168914783905452032,
        -4606131040650196992,
        3955575038343423488,
        -2370880437431001088,
        226284707652505600,
        1971749846479867392,
        -3704140942824855552,
        4561771480761381376,
        -4342105601137810944,
        3097019042617709056,
        -1120548298414835200
        ],
        [
        899695310372275840,
        -2562115475870945280,
        3834476785802889728,
        -4523073764714963968,
        4523073764714962944,
        -3834476785802883072,
        2562115475870955520,
        -899695310372260864,
        -899695310372268672,
        2562115475870962176,
        -3834476785802887680,
        4523073764714964992,
        -4523073764714965504,
        3834476785802871808,
        -2562115475870938624,
        899695310372257024,
        899695310372272512,
        -2562115475870951936,
        3834476785802880512,
        -4523073764714968576,
        4523073764714955264,
        -3834476785802878976,
        2562115475870948864,
        -899695310372269184,
        -899695310372324608,
        2562115475870968832,
        -3834476785802891776,
        4523073764714959872,
        -4523073764714957824,
        3834476785802885632,
        -2562115475870959104,
        899695310372313472
        ],
        [
        676674877523008768,
        -1971749846479849216,
        3097019042617705984,
        -3955575038343413760,
        4473479567794877440,
        -4606131040650197504,
        4342105601137825280,
        -3704140942824855040,
        2747178153714675712,
        -1553630226638944000,
        226284707652512384,
        1120548298414871296,
        -2370880437431045120,
        3417033945137510400,
        -4168914783905443840,
        4561771480761380352,
        -4561771480761380352,
        4168914783905430016,
        -3417033945137510400,
        2370880437431016960,
        -1120548298414807808,
        -226284707652512352,
        1553630226638959616,
        -2747178153714675712,
        3704140942824904192,
        -4342105601137820160,
        4606131040650197504,
        -4473479567794879488,
        3955575038343388160,
        -3097019042617672192,
        1971749846479812352,
        -676674877523039232
        ],
        [
        452024275624070656,
        -1338701787458111232,
        2173933740352749824,
        -2925622638761716224,
        3564881499871153664,
        -4067143964149118464,
        4413108366765435904,
        -4589479489746652672,
        4589479489746651648,
        -4413108366765433344,
        4067143964149114368,
        -3564881499871132672,
        2925622638761709568,
        -2173933740352728064,
        1338701787458106880,
        -452024275624052032,
        -452024275624068864,
        1338701787458123264,
        -2173933740352742912,
        2925622638761722880,
        -3564881499871163904,
        4067143964149129728,
        -4413108366765433344,
        4589479489746651648,
        -4589479489746650624,
        4413108366765430784,
        -4067143964149094912,
        3564881499871158272,
        -2925622638761665024,
        2173933740352734976,
        -1338701787458083072,
        452024275624092544
        ],
        [
        226284707652502656,
        -676674877523011328,
        1120548298414855040,
        -1553630226638958080,
        1971749846479850752,
        -2370880437431042048,
        2747178153714669056,
        -3097019042617711104,
        3417033945137498112,
        -3704140942824870400,
        3955575038343415808,
        -4168914783905443328,
        4342105601137823232,
        -4473479567794876928,
        4561771480761380352,
        -4606131040650198016,
        4606131040650198016,
        -4561771480761375744,
        4473479567794876416,
        -4342105601137811968,
        4168914783905428992,
        -3955575038343414784,
        3704140942824849920,
        -3417033945137508352,
        3097019042617686016,
        -2747178153714681344,
        2370880437431012864,
        -1971749846479857152,
        1553630226638934016,
        -1120548298414802304,
        676674877522989952,
        -226284707652516896
        ]
    ]; 
    
    signal prods[N][N];
    for (var j = 0; j < N; j++) {
        for (var k = 0; k < N; k++) {
            prods[j][k] <== in[k] * coeff[j][k];
        }
    }
    
    signal sums[N][N];
    for (var j = 0; j < N; j++) {
        sums[j][0] <== prods[j][0];
        for (var k = 1; k < N; k++) {
            sums[j][k] <== sums[j][k-1] + prods[j][k];
        }
        out[j] <== sums[j][N-1];
    }
}

// 以下被注释的为使用排序选取中值作为二值化阈值的实现
// 排序网络中的比较和交换单元
template CompareAndSwap(BITS) {
    signal input a;
    signal input b;
    signal output min;
    signal output max;
    
    component lt = LessThan(BITS);
    lt.in[0] <== a;
    lt.in[1] <== b;
    
    component switch = Switcher();
    switch.sel <== lt.out;
    switch.L <== a;
    switch.R <== b;
    
    min <== switch.outL;
    max <== switch.outR;
}

// 64 元素双调排序
template BitonicSort64(BITS) {
    signal input in[64];
    signal output out[64];
    
    signal temp[22][64];
    for (var i = 0; i < 64; i++) {
        temp[0][i] <== in[i];
    }

    component cas[21][32];
    for (var s = 0; s < 21; s++) {
        for (var i = 0; i < 32; i++) {
            cas[s][i] = CompareAndSwap(BITS);
        }
    }

    var step = 0;
    for (var p = 6; p > 0; p--) {
        var n = 1 << p;
        for (var q = p - 1; q >= 0; q--) {
            var d = 1 << q;
            var pairIdx = 0;
            for (var i = 0; i < 64; i++) {
                var j = i ^ d;
                if (j > i) {
                    var dir = (i & n) == 0;
                    cas[step][pairIdx].a <== temp[step][i];
                    cas[step][pairIdx].b <== temp[step][j];
                    if (dir == 0) {
                        temp[step + 1][i] <== cas[step][pairIdx].min;
                        temp[step + 1][j] <== cas[step][pairIdx].max;
                    } else {
                        temp[step + 1][i] <== cas[step][pairIdx].max;
                        temp[step + 1][j] <== cas[step][pairIdx].min;
                    }
                    pairIdx++;
                }
            }
            step++;
        }
    }
    
    for (var i = 0; i < 64; i++) {
        out[i] <== temp[21][i];
    }
}

// 计算感知哈希
template PHash(N, HASH_SIZE, SCALE) {
    signal input image[N][N];     // 输入：NxN 灰度图像
    signal output hash[HASH_SIZE][HASH_SIZE]; // 输出：HASH_SIZExHASH_SIZE 二值哈希
    
    // 对每一行应用 1D DCT
    component dct_rows[N];
    signal temp[N][N];
    for (var i = 0; i < N; i++) {
        dct_rows[i] = DCT1D(N, SCALE);
        for (var k = 0; k < N; k++) {
            dct_rows[i].in[k] <== image[i][k];
        }
        for (var j = 0; j < N; j++) {
            temp[i][j] <== dct_rows[i].out[j];
        }
    }
    
    // 对每一列应用 1D DCT
    component dct_cols[N];
    signal dct_scaled[N][N];
    for (var j = 0; j < N; j++) {
        dct_cols[j] = DCT1D(N, SCALE);
        for (var k = 0; k < N; k++) {
            dct_cols[j].in[k] <== temp[k][j];
        }
        for (var i = 0; i < N; i++) {
            dct_scaled[i][j] <== dct_cols[j].out[i];
        }
    }
    
    // 提取低频区域
    signal lowfreq[HASH_SIZE][HASH_SIZE];
    for (var i = 0; i < HASH_SIZE; i++) {
        for (var j = 0; j < HASH_SIZE; j++) {
            lowfreq[i][j] <== dct_scaled[i][j];
        }
    }
    
    // 展平为 1D 数组
    signal flat[HASH_SIZE * HASH_SIZE];
    var idx = 0;
    for (var i = 0; i < HASH_SIZE; i++) {
        for (var j = 0; j < HASH_SIZE; j++) {
            flat[idx] <== lowfreq[i][j];
            idx++;
        }
    }
    
    // 使用 Bitonic 排序对 64 个值排序 (HASH_SIZE*HASH_SIZE = 64)
    component sorter = BitonicSort64(252);
    for (var i = 0; i < 64; i++) {
        sorter.in[i] <== flat[i];
    }
    signal sorted[64];
    for (var i = 0; i < 64; i++) {
        sorted[i] <== sorter.out[i];
    }
    
    // 计算中值阈值
    signal sum31_32;
    sum31_32 <== sorted[31] + sorted[32];
    
    // 通过与中值比较计算哈希
    component gt[HASH_SIZE][HASH_SIZE];
    for (var i = 0; i < HASH_SIZE; i++) {
        for (var j = 0; j < HASH_SIZE; j++) {
            gt[i][j] = GreaterThan(252);
            gt[i][j].in[0] <== 2 * lowfreq[i][j];
            gt[i][j].in[1] <== sum31_32;
            hash[i][j] <== gt[i][j].out;
        }
    }
}

// component main = PHash(32,8,64);


// // 使用平均值作为二值化阈值的感知哈希实现
// template PHashAvg(N, HASH_SIZE, SCALE) {
//     signal input image[N][N];     // 输入：NxN 灰度图像
//     signal output hash[HASH_SIZE][HASH_SIZE]; // 输出：HASH_SIZExHASH_SIZE 二值哈希
    
//     // 对每一行应用 1D DCT
//     component dct_rows[N];
//     signal temp[N][N];
//     for (var i = 0; i < N; i++) {
//         dct_rows[i] = DCT1D(N, SCALE);
//         for (var k = 0; k < N; k++) {
//             dct_rows[i].in[k] <== image[i][k];
//         }
//         for (var j = 0; j < N; j++) {
//             temp[i][j] <== dct_rows[i].out[j];
//         }
//     }
    
//     // 对每一列应用 1D DCT
//     component dct_cols[N];
//     signal dct_scaled[N][N];
//     for (var j = 0; j < N; j++) {
//         dct_cols[j] = DCT1D(N, SCALE);
//         for (var k = 0; k < N; k++) {
//             dct_cols[j].in[k] <== temp[k][j];
//         }
//         for (var i = 0; i < N; i++) {
//             dct_scaled[i][j] <== dct_cols[j].out[i];
//         }
//     }
    
//     // 提取低频区域
//     signal lowfreq[HASH_SIZE][HASH_SIZE];
//     for (var i = 0; i < HASH_SIZE; i++) {
//         for (var j = 0; j < HASH_SIZE; j++) {
//             lowfreq[i][j] <== dct_scaled[i][j];
//         }
//     }
    
//     // 计算低频系数的平均值
//     signal sum_values;
//     sum_values <== lowfreq[0][0];
    
//     // 累加所有低频值
//     signal running_sum[HASH_SIZE*HASH_SIZE];
//     running_sum[0] <== lowfreq[0][0];
    
//     var idx = 1;
//     for (var i = 0; i < HASH_SIZE; i++) {
//         for (var j = 0; j < HASH_SIZE; j++) {
//             if (i != 0 || j != 0) { // 跳过[0][0]因为已经初始化
//                 running_sum[idx] <== running_sum[idx-1] + lowfreq[i][j];
//                 idx++;
//             }
//         }
//     }
    
//     // 计算平均值
//     signal avg;
//     avg <== running_sum[HASH_SIZE*HASH_SIZE-1] / (HASH_SIZE * HASH_SIZE);
    
//     // 通过与平均值比较计算哈希
//     component gt[HASH_SIZE][HASH_SIZE];
//     for (var i = 0; i < HASH_SIZE; i++) {
//         for (var j = 0; j < HASH_SIZE; j++) {
//             gt[i][j] = GreaterThan(252);
//             gt[i][j].in[0] <== lowfreq[i][j];
//             gt[i][j].in[1] <== avg;
//             hash[i][j] <== gt[i][j].out;
//         }
//     }
// }
// component main = PHashAvg(32,8,64);

